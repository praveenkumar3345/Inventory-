<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Glassmorphism & Layout Styles -->
  <style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
  }

  body {
    background-color: #080710;
    color: #fff;
    overflow-x: hidden;
    min-height: 100vh;
  }

  /* Background glowing shapes */
  .background {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 0;
  }

  .shape {
    position: absolute;
    border-radius: 50%;
    filter: blur(80px);
    opacity: 0.6;
  }

  .shape:nth-child(1) {
    background: linear-gradient(#1845ad, #23a2f6);
    width: 400px;
    height: 400px;
    top: -150px;
    left: -200px;
  }

  .shape:nth-child(2) {
    background: linear-gradient(to right, #ff512f, #f09819);
    width: 350px;
    height: 350px;
    bottom: -150px;
    right: -200px;
  }

  /* Topbar */
  .topbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 30px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.05);
    margin: 20px;
    position: relative;
    z-index: 2;
  }

  .search-box {
    position: relative;
  }

  .search-box input {
    padding: 10px;
    width: 250px;
    border-radius: 8px;
    border: none;
    outline: none;
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
  }

  .search-box input::placeholder {
    color: #ddd;
  }

  #suggestions {
    position: absolute;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    border-radius: 8px;
    width: 100%;
    top: 40px;
    display: none;
    z-index: 3;
  }

  .suggestion {
    padding: 8px;
    cursor: pointer;
    color: #fff;
  }

  .suggestion:hover {
    background: rgba(255,255,255,0.3);
  }

  .add-btn, .logout-btn {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
    padding: 10px 15px;
    border-radius: 8px;
    text-decoration: none;
    transition: 0.3s;
  }

  .add-btn:hover, .logout-btn:hover {
    background: rgba(255, 255, 255, 0.4);
  }

  /* Sidebar */
  .sidebar {
    width: 200px;
    position: fixed;
    top: 100px;
    left: 20px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 0 20px rgba(255,255,255,0.05);
    z-index: 2;
  }

  .sidebar h3 {
    margin-bottom: 15px;
    text-align: center;
  }

  .filter-btn, .analyze-btn {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: none;
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
    cursor: pointer;
    transition: 0.3s;
  }

  .filter-btn:hover, .analyze-btn:hover {
    background: rgba(255, 255, 255, 0.4);
  }

  /* Product cards */
  .card-container {
    margin-left: 250px;
    margin-top: 100px;
    display: flex;
    flex-wrap: wrap;
    gap: 25px;
    padding: 20px;
    justify-content: flex-start;
    position: relative;
    z-index: 2;
  }

  .card {
    width: 220px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(15px);
    border-radius: 15px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    padding: 15px;
    text-align: center;
    transition: transform 0.3s;
  }

  .card:hover {
    transform: scale(1.05);
  }

  .card img {
    width: 180px;
    height: 130px;
    border-radius: 10px;
    object-fit: cover;
  }

  .card h4 {
    margin-top: 10px;
    font-size: 18px;
    color: #f2f2f2; /* changed from blue to light grey */
  }

  .card p {
    font-size: 14px;
    margin: 5px 0;
    color: #ddd;
  }

  /* New matching button styles */
  .view-btn, .edit-btn {
    display: inline-block;
    margin-top: 8px;
    padding: 8px 12px;
    border-radius: 5px;
    text-decoration: none;
    font-weight: 500;
    color: #fff;
    transition: all 0.3s ease;
  }

  .view-btn {
    background: linear-gradient(90deg, #007bff, #00bcd4);
  }

  .edit-btn {
    background: linear-gradient(90deg, #9c27b0, #e040fb);
  }

  .view-btn:hover {
    filter: brightness(1.2);
  }

  .edit-btn:hover {
    filter: brightness(1.2);
  }
</style>

</head>
<body>

  <!-- Glowing background -->
  <div class="background">
    <div class="shape"></div>
    <div class="shape"></div>
  </div>

  <!-- Top Navigation -->
  <div class="topbar">
    <div style="display:flex; align-items:center; gap:10px;">
      <div class="search-box">
        <input type="text" id="search" placeholder="Search product...">
        <div id="suggestions"></div>
      </div>
      <button id="open-locations" class="locations-btn">üìç Locations</button>
    </div>
    <div style="display:flex; align-items:center; gap:8px;">
      <span class="update-locations-label">Update locations</span>
      <a href="/add" class="add-btn">+ Add Product</a>
      <a href="/logout" class="logout-btn">Logout</a>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar">
    <h3>Filters</h3>
    <button class="filter-btn" data-category="">All</button>
    <button class="filter-btn" data-category="Laptop">Laptop</button>
    <button class="filter-btn" data-category="Mobile">Mobile</button>
    <button class="filter-btn" data-category="Smart Watch">Smart Watch</button>
    <a href="/analyze" class="analyze-btn">Analyze</a>
  </div>

  <!-- Product Grid -->
  <div class="card-container" id="product-list">
    {% for product in products %}
    <div class="card">
      <img src="{{ url_for('static', filename='images/' + product.image) }}" alt="{{ product.name }}">
      <h4>{{ product.name }}</h4>
      <p>Category: {{ product.category }}</p>
      <p>Qty: {{ product.quantity }}</p>
      <a href="/product/{{ product.id }}" class="view-btn">View</a>
      <a href="/edit/{{ product.id }}" class="edit-btn">Edit</a>
    </div>
    {% endfor %}
  </div>

  <!-- JS Functionality (same as before) -->
  <script>
  $(document).ready(function() {
    $(".filter-btn").click(function() {
      let category = $(this).data("category");
      $.get("/filter", { category: category }, function(data) {
        $("#product-list").html("");
        data.forEach(function(p) {
          $("#product-list").append(`
            <div class="card">
              <img src="/static/images/${p.image}" alt="${p.name}">
              <h4>${p.name}</h4>
              <p>Category: ${p.category}</p>
              <p>Qty: ${p.quantity}</p>
              <a href="/product/${p.id}" class="view-btn">View</a>
              <a href="/edit/${p.id}" class="edit-btn">Edit</a>
            </div>
          `);
        });
      });
    });

    $("#search").on("input", function() {
      let q = $(this).val();
      if (q.length > 0) {
        $.get("/search_suggestions", { query: q }, function(data) {
          $("#suggestions").show().html("");
          data.forEach(function(name) {
            $("#suggestions").append(`<div class="suggestion">${name}</div>`);
          });

          $(".suggestion").click(function() {
            $("#search").val($(this).text());
            $("#suggestions").hide();
            searchProducts($(this).text());
          });
        });
      } else {
        $("#suggestions").hide();
      }
    });

    $("#search").keypress(function(e) {
      if (e.which === 13) {
        let query = $(this).val();
        searchProducts(query);
        $("#suggestions").hide();
        return false;
      }
    });

    $(document).click(function(e) {
      if (!$(e.target).closest("#search, #suggestions").length) {
        $("#suggestions").hide();
      }
    });

    function searchProducts(query) {
      $.get("/search", { query: query }, function(data) {
        $("#product-list").html("");
        if (data.length === 0) {
          $("#product-list").html("<p style='text-align:center; color:red;'>No products found.</p>");
        } else {
          data.forEach(function(p) {
            $("#product-list").append(`
              <div class="card">
                <img src="/static/images/${p.image}" alt="${p.name}">
                <h4>${p.name}</h4>
                <p>Category: ${p.category}</p>
                <p>Qty: ${p.quantity}</p>
                <a href="/product/${p.id}" class="view-btn">View</a>
                <a href="/edit/${p.id}" class="edit-btn">Edit</a>
              </div>
            `);
          });
        }
      });
    }
  });
  </script>

  <!-- Locations modal and JS -->
  <div id="locations-modal" class="locations-modal" style="display:none;">
    <div class="locations-modal-content">
      <div class="locations-header">
        <h3>Locations</h3>
        <button id="close-locations" class="edit-btn">Close</button>
      </div>
      <div id="locations-list" class="locations-list">
        <!-- populated by JS -->
      </div>
      <div id="locations-feedback" style="margin-top:10px;color:#fff"></div>
    </div>
  </div>

  <script>
  $(document).ready(function() {
    function fetchLocations() {
      $.get('/locations', function(data) {
        renderLocations(data || []);
      });
    }

    function renderLocations(list) {
      const $container = $('#locations-list');
      $container.html('');
      if (!list.length) {
        $container.html('<p style="color:#fff;">No locations found.</p>');
        return;
      }

      list.forEach(function(loc) {
        const item = $(
          `<div class="locations-item" data-id="${loc.id}">
             <div class="loc-row">
               <div class="loc-id">ID: ${loc.id}</div>
               <div class="loc-branch">Branch: <span class="branch-text">${escapeHtml(loc.branch_name)}</span></div>
               <div class="loc-city">City: <span class="city-text">${escapeHtml(loc.city)}</span></div>
               <div class="loc-actions">
                 <button class="edit-loc-btn edit-btn">Edit</button>
               </div>
             </div>
           </div>`
        );

        // Edit handler
        item.find('.edit-loc-btn').click(function() {
          enterEditMode(item, loc);
        });

        $container.append(item);
      });
    }

    function enterEditMode($item, loc) {
      const id = loc.id;
      const branch = $item.find('.branch-text').text();
      const city = $item.find('.city-text').text();

      const editHtml = `
        <div class="loc-row edit-mode">
          <div class="loc-id">ID: ${id}</div>
          <div class="loc-branch">Branch: <input class="branch-input" value="${escapeAttr(branch)}"></div>
          <div class="loc-city">City: <input class="city-input" value="${escapeAttr(city)}"></div>
          <div class="loc-actions">
            <button class="save-loc-btn view-btn">Save</button>
            <button class="cancel-loc-btn edit-btn">Cancel</button>
          </div>
        </div>`;

      $item.html(editHtml);

      $item.find('.cancel-loc-btn').click(function() {
        fetchLocations();
      });

      $item.find('.save-loc-btn').click(function() {
        const newBranch = $item.find('.branch-input').val();
        const newCity = $item.find('.city-input').val();
        if (!newBranch || !newCity) {
          showFeedback('Branch and city are required', true);
          return;
        }

        $.post(`/locations/update/${id}`, { branch_name: newBranch, city: newCity }, function(resp) {
          if (resp && resp.success) {
            showFeedback('Location updated successfully');
            fetchLocations();
          } else {
            showFeedback((resp && resp.message) || 'Update failed', true);
          }
        }).fail(function(xhr) {
          let msg = 'Update failed';
          try { msg = JSON.parse(xhr.responseText).message || msg; } catch(e) {}
          showFeedback(msg, true);
        });
      });
    }

    function showFeedback(msg, isError) {
      $('#locations-feedback').text(msg).css('color', isError ? '#ff6b6b' : '#8ef5a1');
      setTimeout(function(){ $('#locations-feedback').text(''); }, 3000);
    }

    function escapeHtml(s) {
      if (!s && s !== 0) return '';
      return String(s).replace(/[&<>"']/g, function(c) {
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c];
      });
    }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

    // Open/close modal
    $('#open-locations').click(function() {
      $('#locations-modal').fadeIn(150);
      fetchLocations();
    });
    $('#close-locations').click(function() { $('#locations-modal').fadeOut(150); });
    $(document).on('keydown', function(e) { if (e.key === 'Escape') $('#locations-modal').fadeOut(150); });
  });
  </script>
</body>
</html>
